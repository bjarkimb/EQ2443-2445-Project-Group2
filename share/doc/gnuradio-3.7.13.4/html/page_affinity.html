<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>GNU Radio Manual and C++ API Reference: Block Thread Affinity and Priority</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="gnuradio_logo_icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">GNU Radio Manual and C++ API Reference
   &#160;<span id="projectnumber">3.7.13.4</span>
   </div>
   <div id="projectbrief">The Free &amp; Open Software Radio Ecosystem</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_affinity.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Block Thread Affinity and Priority </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="affinity"></a>
Block Thread Affinity</h1>
<p>In the thread-per-block scheduler, you can set the block's core affinity. Each block can be pinned to a group cores or be set back to use the standard kernel scheduler.</p>
<p>The implementation is done by adding new functions to the threading section of the gnuradio-runtime library:</p>
<div class="fragment"><div class="line"><a class="code" href="namespacegr_1_1thread.html#aa33c619fe30adea573dec1d14ae7ff53">gr::thread::gr_thread_t</a> <a class="code" href="namespacegr_1_1thread.html#af9dc23036fa4f6453bbaa7b3060471e9">get_current_thread_id</a>();</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacegr_1_1thread.html#aab5195edcd94db5c71ecbfef9d578fb7">thread_bind_to_processor</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n);</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacegr_1_1thread.html#aab5195edcd94db5c71ecbfef9d578fb7">thread_bind_to_processor</a>(<span class="keyword">const</span> std::vector&lt;unsigned int&gt; &amp;mask);</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacegr_1_1thread.html#aab5195edcd94db5c71ecbfef9d578fb7">thread_bind_to_processor</a>(<a class="code" href="namespacegr_1_1thread.html#aa33c619fe30adea573dec1d14ae7ff53">gr::thread::gr_thread_t</a> <a class="code" href="namespacegr_1_1thread.html#a8db1729ee02223979eb266b92f6cdd64">thread</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n);</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacegr_1_1thread.html#aab5195edcd94db5c71ecbfef9d578fb7">thread_bind_to_processor</a>(<a class="code" href="namespacegr_1_1thread.html#aa33c619fe30adea573dec1d14ae7ff53">gr::thread::gr_thread_t</a> <a class="code" href="namespacegr_1_1thread.html#a8db1729ee02223979eb266b92f6cdd64">thread</a>, <span class="keyword">const</span> std::vector&lt;unsigned int&gt; &amp;mask);</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacegr_1_1thread.html#a889aef68ac073f83d081d3bcd891690a">thread_unbind</a>();</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacegr_1_1thread.html#a889aef68ac073f83d081d3bcd891690a">thread_unbind</a>(<a class="code" href="namespacegr_1_1thread.html#aa33c619fe30adea573dec1d14ae7ff53">gr::thread::gr_thread_t</a> <a class="code" href="namespacegr_1_1thread.html#a8db1729ee02223979eb266b92f6cdd64">thread</a>);</div></div><!-- fragment --><p>The ability to set a thread's affinity to a core or groups of cores is not implemented in the Boost thread library, and so we have made our own portability library. In particular, the <a class="el" href="namespacegr_1_1thread.html#aa33c619fe30adea573dec1d14ae7ff53" title="a system-dependent typedef for the underlying thread type. ">gr::thread::gr_thread_t</a> type is defined as the thread type for the given system. The other functions are designed to be portable as well by calling the specific implementation for the thread affinity for a particular platform.</p>
<p>There are functions to set a thread to a group of cores. If the thread is not given, the current thread is used. If a single number is passed, only that core is set (this is equivalent to a core mask with just a single value).</p>
<p>Similarly, there are functions to unset the affinity. This practically implements the setting of the thread's affinity to all possible cores. Again, the function that does not take a thread argument unsets the affinity for the current thread.</p>
<p>NOTE: Not available on OSX.</p>
<h2><a class="anchor" id="affinity_api"></a>
GNU Radio Block API</h2>
<p>Each block has two new data members:</p>
<ul>
<li>threaded: a boolean value that is true if the block is attached to a thread.</li>
<li>thread: a <a class="el" href="namespacegr_1_1thread.html#aa33c619fe30adea573dec1d14ae7ff53" title="a system-dependent typedef for the underlying thread type. ">gr::thread::gr_thread_t</a> handle to the block's thread.</li>
</ul>
<p>A block can set and unset its affinity at any time using the following member functions:</p>
<ul>
<li><a class="el" href="classgr_1_1block.html#a05ad2ae50b0f7c922add44e74d9603b8" title="Set the thread&#39;s affinity to processor core n. ">gr::block::set_processor_affinity(const std::vector&lt;int&gt; &amp;mask)</a></li>
<li><a class="el" href="classgr_1_1block.html#ac077773948a5f55b826dd638e1ed3863" title="Remove processor affinity to a specific core. ">gr::block::unset_processor_affinity()</a></li>
</ul>
<p>Where <code>mask</code> is a vector of core numbers to set the thread's affinity to.</p>
<p>The current core affinity can be retrieved using the member function:</p>
<ul>
<li><a class="el" href="classgr_1_1block.html#a3b37bd70477161aa97d1e868ff2b20d9" title="Get the current processor affinity. ">gr::block::processor_affinity()</a></li>
</ul>
<p>When set before the flowgraph is started, the scheduler will set the thread's affinity when it is started. When already running, the block's affinity will be immediately set.</p>
<h2><a class="anchor" id="affinity_api_hier"></a>
Setting Affinity for a gr::hier_block2</h2>
<p>A hierarchical block (<a class="el" href="classgr_1_1hier__block2.html" title="Hierarchical container class for gr::block&#39;s and gr::hier_block2&#39;s. ">gr::hier_block2</a>) also has a concept of setting the block thread affinity. Because the hierarchical block itself does no work and just encapsulates a set of blocks, setting the hierarchical block's affinity individually sets all blocks inside it to that affinity setting.</p>
<p>The <a class="el" href="classgr_1_1hier__block2.html" title="Hierarchical container class for gr::block&#39;s and gr::hier_block2&#39;s. ">gr::hier_block2</a> class supports the same API interface to the block thread affinity:</p>
<ul>
<li><a class="el" href="classgr_1_1hier__block2.html#a8291a79bc15ee093482739ec01a8c27c" title="Set the affinity of all blocks in hier_block2 to processor core n. ">gr::hier_block2::set_processor_affinity(const std::vector&lt;int&gt; &amp;mask)</a></li>
<li><a class="el" href="classgr_1_1hier__block2.html#a5c7f8d08d76faea2999ff66c648b2da3" title="Remove processor affinity for all blocks in hier_block2. ">gr::hier_block2::unset_processor_affinity()</a></li>
<li><a class="el" href="classgr_1_1hier__block2.html#ae061dc0b8b82faba2dd13738e7a7ae0c" title="Get the current processor affinity. ">gr::hier_block2::processor_affinity()</a></li>
</ul>
<p>Setting and unsetting the affinity does so recursively for every block in the hierarchical block. It is of course possible to individually set the affinity to any block underneath the hierarchical block. However, in this case, note that when asking for the current affinity value using 'processor_affinity()', the code returns the current processor affinity value of only the first block.</p>
<h2><a class="anchor" id="affinity_api_grc"></a>
GRC Access</h2>
<p>GRC supports the setting of the thread core affinity in a block's options. Each block now has a field 'Core Affinity' that accepts a vector (list) of integers and sets the affinity after the block is constructed.</p>
<p>Note that GRC does not provide a callback function for changing the thread core affinity while the flowgraph is running.</p>
<h1><a class="anchor" id="priority_api"></a>
Setting Thread Priority</h1>
<p>Similarly to setting the core affinity for a given block, we can also set the thread priority. This concept adds three new function calls to all blocks:</p>
<ul>
<li><a class="el" href="classgr_1_1block.html#a83e0fd5c4db199e6e6f2fc75cdfb5dfa" title="Set the current thread priority. ">gr::block::set_thread_priority(int priority)</a>: Sets the current thread priority. </li>
<li><a class="el" href="classgr_1_1block.html#a099f578878243499d63846bbee61979a" title="Get the current thread priority in use. ">gr::block::active_thread_priority()</a>: Gets the active priority for the thread. </li>
<li><a class="el" href="classgr_1_1block.html#a585b831aea5775730931d7fb9e6e8253" title="Get the current thread priority stored. ">gr::block::thread_priority()</a>: Gets the stored thread priority.</li>
</ul>
<p>The range of the thread priority might be system dependent, so look to your system/OS documentation. Linux specifies this range in <b>sched_setscheduler</b> as a value between 1 and 99 where 1 is the lowest priority and 99 is the highest. POSIX systems can retrieve these min and max values using <b>sched_get_priority_min</b> and <b>sched_get_priority_max</b> and may only allow 32 distinct values to be set.</p>
<p>NOTE: Not available on Windows or OSX. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
